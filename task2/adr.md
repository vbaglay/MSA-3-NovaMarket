В NovaMarket мы используем КОМБИНАЦИЮ:
Notification - для Saga хореографии (OrderCreated, PaymentCompleted)
State Transfer - для данных товаров в истории заказов
Event Sourcing - для полного аудита заказов


### **Название задачи:** Выбор архитектуры для истории заказов
### **Автор:** Архитектор NovaMarket
### **Дата:** 2024-01-20

### **Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|1|Покупатель|Просмотр истории заказов|Видит список всех заказов с датами, суммами, статусами|
|2|Покупатель|Просмотр деталей заказа|Видит полную историю изменений заказа, товары с ценами на момент заказа|
|3|Покупатель|Скачивание чека|Генерирует и скачивает PDF чек по заказу|
|4|Покупатель|Оставление отзыва|Оставляет отзыв о товаре после доставки|
|5|Покупатель|Повторный заказ|Создает новый заказ с теми же товарами|

### **Нефункциональные требования**

|**№**|**Требование**|
| :-: | :- |
|1|Отклик интерфейса < 0.3 сек в 98% случаев|
|2|Полная история всех изменений заказа|
|3|Масштабируемость до 40k+ заказов в день|
|4|Легкость добавления новых представлений данных|

### **Решение**

### **Решение**

Выбрана архитектура **Event Sourcing для истории заказов** с разделением ответственности.

**Компоненты:**
- **Бизнес-сервисы** (Order, Catalog, Payment, Delivery) - участвуют в Saga хореографии через RabbitMQ
- **Order History Service** - отдельный сервис, подписанный на ВСЕ события из RabbitMQ
- **Event Store** - хранение неизменяемой последовательности событий для аудита
- **Order History DB** - денормализованная модель для быстрого чтения истории

**Обоснование:**
- Event Sourcing обеспечивает полную историю всех изменений заказа через потребление событий
- Бизнес-сервисы остаются простыми (PostgreSQL) и не усложняются Event Sourcing
- Order History Service специализируется только на истории и аудите
- Read-модели гарантируют производительность < 0.3 сек для UI
- Легко добавлять новых потребителей событий для аналитики, отчетов и т.д.

### **Альтернативы**

**API Composition**
- *Плюсы:* Проще реализация, меньше компонентов
- *Минусы:* Медленные запросы (много JOIN), нет полной истории

**CQRS без Event Sourcing**
- *Плюсы:* Хорошая производительность чтения
- *Минусы:* Только финальное состояние, нет истории изменений

**Традиционная CRUD**
- *Плюсы:* Знакомая модель
- *Минусы:* Плохая производительность, сложный аудит

**Недостатки, ограничения, риски**

*Сложность реализации:* Event Sourcing требует глубокого понимания паттерна
*Объем данных:* Event Store может расти быстро, нужна стратегия архивации
*Согласованность в конечном счете:* Read-модели могут отставать от write-модели
*Обучение команды:* Нужно время на освоение новых концепций